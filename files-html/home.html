<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Welcome, <span id="userName"></span></h1>
    
    <button onclick="toggleAddOrder()">Add Order</button>
    <div id="addOrderDiv" class="hidden">
        <h2>Add Order</h2>
        <form id="orderForm" onsubmit="addOrder(event)">
            <label for="customerName">Customer Name:</label>
            <input type="text" id="customerName" required>
            <br>
            <label for="customerNumber">Customer Number:</label>
            <input type="text" id="customerNumber" required>
            <br>
            <label for="customerAddress">Customer Address:</label>
            <input type="text" id="customerAddress" required>
            <br>
            <label for="deliveryPersonSelect">Select Delivery Person:</label>
            <select id="deliveryPersonSelect" required>
                <option value="">Select a delivery person</option>
                <!-- سيتم ملء هذه الخيارات من JavaScript -->
            </select>
            <br>
            <button type="submit">Submit Order</button>
        </form>
    </div>

    <button onclick="toggleAllOrders()">All Orders (<span id="orderCount">0</span>)</button>
    <div id="allOrdersDiv" class="hidden">
        <h2>All Orders</h2>
        <table id="ordersTable">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer Name</th>
                    <th>Customer Number</th>
                    <th>Customer Address</th>
                    <th>Delivery Person ID</th>
                    <th>Date & Time</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                <!-- Orders will be populated here -->
            </tbody>
        </table>
    </div>

    <button onclick="toggleAddDeliveryPerson()">Add Delivery Person</button>
    <div id="addDeliveryPersonDiv" class="hidden">
        <h2>Add Delivery Person</h2>
        <form id="deliveryForm" onsubmit="addDeliveryPerson(event)">
            <label for="deliveryName">Delivery Person Name:</label>
            <input type="text" id="deliveryName" required>
            <br>
            <label for="deliveryNumber">Delivery Person Number:</label>
            <input type="text" id="deliveryNumber" required>
            <br>
            <label for="deliveryPassword">Password:</label> <!-- إضافة حقل إدخال كلمة المرور -->
            <input type="password" id="deliveryPassword" required>
            <br>
            <label for="deliveryNote">Note:</label>
            <input type="text" id="deliveryNote">
            <br>
            <button type="submit">Submit Delivery Person</button>
        </form>
    </div>

    <button onclick="toggleAllDeliveryPersons()">All Delivery Persons (<span id="deliveryCount">0</span>)</button>
    <div id="allDeliveryPersonsDiv" class="hidden">
        <h2>All Delivery Persons</h2>
        <table id="deliveryPersonsTable">
            <thead>
                <tr>
                    <th>Delivery ID</th>
                    <th>Delivery Person Name</th>
                    <th>Delivery Person Number</th>
                    <th>Password</th> <!-- إضافة عمود لعرض كلمة المرور -->
                    <th>Note</th>
                    <th>Date & Time</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="deliveryPersonsTableBody">
                <!-- Delivery persons will be populated here -->
            </tbody>
        </table>
    </div>

    <a href="login.html">Exit</a>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzWStPRbvQ4f6Wp13iCw70N60IfZIBcGw",
            authDomain: "web-cv-pro.firebaseapp.com",
            projectId: "web-cv-pro",
            storageBucket: "web-cv-pro.appspot.com",
            messagingSenderId: "282734467735",
            appId: "1:282734467735:web:ad0f4f4c160999198327d2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const userEmail = localStorage.getItem('userEmail');
        document.getElementById('userName').innerText = userEmail || 'Guest';

        const ordersRef = database.ref(`orders/${userEmail.replace('.', '_')}`);
        const deliveryPersonsRef = database.ref('deliveryPersons');
        let lastOrderId = 0;
        let lastDeliveryId = 0;

        // Function to toggle Add Order section
        function toggleAddOrder() {
            const div = document.getElementById('addOrderDiv');
            div.classList.toggle('hidden');
        }

        // Function to toggle All Orders section
        function toggleAllOrders() {
            const div = document.getElementById('allOrdersDiv');
            div.classList.toggle('hidden');
            loadOrders();
        }

        // Function to toggle Add Delivery Person section
        function toggleAddDeliveryPerson() {
            const div = document.getElementById('addDeliveryPersonDiv');
            div.classList.toggle('hidden');
        }

        // Function to toggle All Delivery Persons section
        function toggleAllDeliveryPersons() {
            const div = document.getElementById('allDeliveryPersonsDiv');
            div.classList.toggle('hidden');
            loadDeliveryPersons();
        }

        // Function to load delivery persons for the select field
        function loadDeliveryPersonsForSelect() {
            deliveryPersonsRef.on('value', snapshot => {
                const deliveryPersonSelect = document.getElementById('deliveryPersonSelect');
                deliveryPersonSelect.innerHTML = '<option value="">Select a delivery person</option>';
                const deliveryPersons = snapshot.val();

                if (deliveryPersons) {
                    for (let id in deliveryPersons) {
                        const person = deliveryPersons[id];
                        const option = `<option value="${person.id}">${person.name}</option>`;
                        deliveryPersonSelect.innerHTML += option;
                    }
                }
            });
        }

        // Function to add an order
        function addOrder(event) {
            event.preventDefault();
            const customerName = document.getElementById('customerName').value;
            const customerNumber = document.getElementById('customerNumber').value;
            const customerAddress = document.getElementById('customerAddress').value;
            const selectedDeliveryPersonId = document.getElementById('deliveryPersonSelect').value;

            if (lastOrderId < 1000) {
                lastOrderId++;
            } else {
                alert('Maximum order limit reached.');
                return;
            }

            const orderData = {
                id: lastOrderId,
                name: customerName,
                number: customerNumber,
                address: customerAddress,
                deliveryPersonId: selectedDeliveryPersonId,
                timestamp: new Date().toLocaleString()
            };

            // إضافة الطلب
            ordersRef.child(lastOrderId).set(orderData).then(() => {
                // حفظ الطلبات المحملة
                const deliveryOrdersRef = database.ref(`deliveryOrders/${selectedDeliveryPersonId}`);
                deliveryOrdersRef.child(lastOrderId).set({
                    customerName: customerName,
                    customerNumber: customerNumber,
                    customerAddress: customerAddress,
                    timestamp: orderData.timestamp
                });

                alert('Order added successfully!');
                document.getElementById('orderForm').reset();
                loadOrders();
            }).catch(error => {
                console.error('Error adding order:', error);
            });
        }

        // Load user's orders from Firebase
        function loadOrders() {
            ordersRef.on('value', snapshot => {
                const ordersTableBody = document.getElementById('ordersTableBody');
                ordersTableBody.innerHTML = ''; 
                const orders = snapshot.val();
                let orderCount = 0;

                if (orders) {
                    orderCount = Object.keys(orders).length;
                    for (let id in orders) {
                        const order = orders[id];
                        const row = `<tr>
                                        <td>${order.id}</td>
                                        <td>${order.name}</td>
                                        <td>${order.number}</td>
                                        <td>${order.address}</td>
                                        <td>${order.deliveryPersonId}</td>
                                        <td>${order.timestamp}</td>
                                    </tr>`;
                        ordersTableBody.innerHTML += row;
                    }
                }
                
                document.getElementById('orderCount').innerText = orderCount;
            });
        }

        // Add a delivery person
        function addDeliveryPerson(event) {
            event.preventDefault();
            const deliveryName = document.getElementById('deliveryName').value;
            const deliveryNumber = document.getElementById('deliveryNumber').value;
            const deliveryPassword = document.getElementById('deliveryPassword').value; // تخزين كلمة المرور
            const deliveryNote = document.getElementById('deliveryNote').value;

            if (lastDeliveryId < 1000) {
                lastDeliveryId++;
            } else {
                alert('Maximum delivery person limit reached.');
                return;
            }

            const deliveryData = {
                id: lastDeliveryId,
                name: deliveryName,
                number: deliveryNumber,
                password: deliveryPassword, // إضافة كلمة المرور إلى البيانات
                note: deliveryNote,
                timestamp: new Date().toLocaleString()
            };

            deliveryPersonsRef.child(lastDeliveryId).set(deliveryData).then(() => {
                alert('Delivery person added successfully!');
                document.getElementById('deliveryForm').reset();
                loadDeliveryPersons();
            }).catch(error => {
                console.error('Error adding delivery person:', error);
            });
        }

        // Load all delivery persons from Firebase
        function loadDeliveryPersons() {
            deliveryPersonsRef.on('value', snapshot => {
                const deliveryPersonsTableBody = document.getElementById('deliveryPersonsTableBody');
                deliveryPersonsTableBody.innerHTML = '';
                const deliveryPersons = snapshot.val();
                let deliveryCount = 0;

                if (deliveryPersons) {
                    deliveryCount = Object.keys(deliveryPersons).length;
                    for (let id in deliveryPersons) {
                        const person = deliveryPersons[id];
                        const row = `<tr>
                                        <td>${person.id}</td>
                                        <td>${person.name}</td>
                                        <td>${person.number}</td>
                                        <td>${person.password}</td> <!-- عرض كلمة المرور -->
                                        <td>${person.note}</td>
                                        <td>${person.timestamp}</td>
                                        <td><button onclick="deleteDeliveryPerson(${person.id})">Delete</button></td>
                                    </tr>`;
                        deliveryPersonsTableBody.innerHTML += row;
                    }
                }

                document.getElementById('deliveryCount').innerText = deliveryCount;
            });
        }

        // Delete a delivery person
        function deleteDeliveryPerson(id) {
            if (confirm('Are you sure you want to delete this delivery person?')) {
                deliveryPersonsRef.child(id).remove().then(() => {
                    alert('Delivery person deleted successfully!');
                    loadDeliveryPersons();
                }).catch(error => {
                    console.error('Error deleting delivery person:', error);
                });
            }
        }

        // Initialize data
        loadOrders();
        loadDeliveryPersonsForSelect();
    </script>
</body>
</html>
